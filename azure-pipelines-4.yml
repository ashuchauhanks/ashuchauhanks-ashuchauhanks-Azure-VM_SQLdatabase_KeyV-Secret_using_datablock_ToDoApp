

trigger: none
pool: selfhostagent


stages:
- stage: PreCommit
  displayName: terraform init
  jobs:
  - job: InitJob
    displayName: Terraform Init
    steps: 
    - task: TerraformTask@5
      displayName: TerraformInit
      inputs:
        provider: 'azurerm'
        command: 'init'
        workingDirectory: '$(System.DefaultWorkingDirectory)/Azure-VM_SQLdatabase_KeyV-Secret_using_datablock/root'
        backendServiceArm: 'ashu-Service-connection'
        backendAzureRmResourceGroupName: 'rg-bknd-ashu'
        backendAzureRmStorageAccountName: 'stgbkendpipelineashu'
        backendAzureRmContainerName: 'tfcontainer'
        backendAzureRmKey: 'root.tfstate'

    - task: PowerShell@2
      displayName: tflint
      continueOnError: true
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)/Azure-VM_SQLdatabase_KeyV-Secret_using_datablock/root
          tflint --init
          tflint

    - task: PowerShell@2
      displayName: checkov
      inputs:
        targetType: 'inline'
        script: |
          cd $(System.DefaultWorkingDirectory)/Azure-VM_SQLdatabase_KeyV-Secret_using_datablock/root
          checkov -d


